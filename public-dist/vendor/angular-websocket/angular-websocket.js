(function(){"use strict";function l(e,l,c,h){function p(n,r,i){!i&&o(r)&&!u(r)&&(i=r,r=undefined),this.protocols=r,this.url=n||"Missing URL",this.ssl=/(wss)/i.test(this.url),this.scope=i&&i.scope||e,this.rootScopeFailover=i&&i.rootScopeFailover&&!0,this.useApplyAsync=i&&i.useApplyAsync||!1,this.initialTimeout=i&&i.initialTimeout||500,this.maxTimeout=i&&i.maxTimeout||3e5,this.reconnectIfNotNormalClose=i&&i.reconnectIfNotNormalClose||!1,this._reconnectAttempts=0,this.sendQueue=[],this.onOpenCallbacks=[],this.onMessageCallbacks=[],this.onErrorCallbacks=[],this.onCloseCallbacks=[],t(this._readyStateConstants),n?this._connect():this._setInternalState(0)}return p.prototype._readyStateConstants={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,RECONNECT_ABORTED:4},p.prototype._normalCloseCode=1e3,p.prototype._reconnectableStatusCodes=[4e3],p.prototype.safeDigest=function(t){t&&!this.scope.$$phase&&this.scope.$digest()},p.prototype.bindToScope=function(n){var r=this;return n&&(this.scope=n,this.rootScopeFailover&&this.scope.$on("$destroy",function(){r.scope=e})),r},p.prototype._connect=function(t){if(t||!this.socket||this.socket.readyState!==this._readyStateConstants.OPEN)this.socket=h.create(this.url,this.protocols),this.socket.onmessage=angular.bind(this,this._onMessageHandler),this.socket.onopen=angular.bind(this,this._onOpenHandler),this.socket.onerror=angular.bind(this,this._onErrorHandler),this.socket.onclose=angular.bind(this,this._onCloseHandler)},p.prototype.fireQueue=function(){while(this.sendQueue.length&&this.socket.readyState===this._readyStateConstants.OPEN){var t=this.sendQueue.shift();this.socket.send(r(t.message)?t.message:JSON.stringify(t.message)),t.deferred.resolve()}},p.prototype.notifyOpenCallbacks=function(t){for(var n=0;n<this.onOpenCallbacks.length;n++)this.onOpenCallbacks[n].call(this,t)},p.prototype.notifyCloseCallbacks=function(t){for(var n=0;n<this.onCloseCallbacks.length;n++)this.onCloseCallbacks[n].call(this,t)},p.prototype.notifyErrorCallbacks=function(t){for(var n=0;n<this.onErrorCallbacks.length;n++)this.onErrorCallbacks[n].call(this,t)},p.prototype.onOpen=function(t){return this.onOpenCallbacks.push(t),this},p.prototype.onClose=function(t){return this.onCloseCallbacks.push(t),this},p.prototype.onError=function(t){return this.onErrorCallbacks.push(t),this},p.prototype.onMessage=function(t,n){if(!i(t))throw new Error("Callback must be a function");if(n&&s(n.filter)&&!r(n.filter)&&!(n.filter instanceof RegExp))throw new Error("Pattern must be a string or regular expression");return this.onMessageCallbacks.push({fn:t,pattern:n?n.filter:undefined,autoApply:n?n.autoApply:!0}),this},p.prototype._onOpenHandler=function(t){this._reconnectAttempts=0,this.notifyOpenCallbacks(t),this.fireQueue()},p.prototype._onCloseHandler=function(t){this.notifyCloseCallbacks(t),(this.reconnectIfNotNormalClose&&t.code!==this._normalCloseCode||this._reconnectableStatusCodes.indexOf(t.code)>-1)&&this.reconnect()},p.prototype._onErrorHandler=function(t){this.notifyErrorCallbacks(t)},p.prototype._onMessageHandler=function(t){function u(e,t,n){n=f.call(arguments,2),i.useApplyAsync?i.scope.$applyAsync(function(){e.apply(i,n)}):(e.apply(i,n),i.safeDigest(t))}var n,i=this,s;for(var o=0;o<i.onMessageCallbacks.length;o++)s=i.onMessageCallbacks[o],n=s.pattern,n?r(n)&&t.data===n?u(s.fn,s.autoApply,t):n instanceof RegExp&&n.exec(t.data)&&u(s.fn,s.autoApply,t):u(s.fn,s.autoApply,t)},p.prototype.close=function(t){return(t||!this.socket.bufferedAmount)&&this.socket.close(),this},p.prototype.send=function(t){function s(e){e.cancel=o;var t=e.then;return e.then=function(){var e=t.apply(this,arguments);return s(e)},e}function o(e){return r.sendQueue.splice(r.sendQueue.indexOf(t),1),n.reject(e),r}var n=l.defer(),r=this,i=s(n.promise);return r.readyState===r._readyStateConstants.RECONNECT_ABORTED?n.reject("Socket connection has been closed"):(r.sendQueue.push({message:t,deferred:n}),r.fireQueue()),h.isMocked&&h.isMocked()&&h.isConnected(this.url)&&this._onMessageHandler(h.mockSend()),i},p.prototype.reconnect=function(){this.close();var t=this._getBackoffDelay(++this._reconnectAttempts),n=t/1e3;return console.log("Reconnecting in "+n+" seconds"),c(angular.bind(this,this._connect),t),this},p.prototype._getBackoffDelay=function(t){var n=Math.random()+1,r=this.initialTimeout,i=2,s=t,o=this.maxTimeout;return Math.floor(Math.min(n*r*Math.pow(i,s),o))},p.prototype._setInternalState=function(t){if(Math.floor(t)!==t||t<0||t>4)throw new Error("state must be an integer between 0 and 4, got: "+t);n||(this.readyState=t||this.socket.readyState),this._internalConnectionState=t,a(this.sendQueue,function(e){e.deferred.reject("Message cancelled due to closed socket connection")})},n&&n(p.prototype,"readyState",{get:function(){return this._internalConnectionState||this.socket.readyState},set:function(){throw new Error("The readyState property is read-only")}}),function(e,t,n){return new p(e,t,n)}}function c(e,t){this.create=function(n,r){var i=/wss?:\/\//.exec(n),s,o;if(!i)throw new Error("Invalid url provided");if(typeof exports=="object"&&require)try{o=require("ws"),s=o.Client||o.client||o}catch(u){}return s=s||e.WebSocket||e.MozWebSocket,r?new s(n,r):new s(n)},this.createWebSocketBackend=function(n,r){return t.warn("Deprecated: Please use .create(url, protocols)"),this.create(n,r)}}var e=angular.noop,t=Object.freeze?Object.freeze:e,n=Object.defineProperty,r=angular.isString,i=angular.isFunction,s=angular.isDefined,o=angular.isObject,u=angular.isArray,a=angular.forEach,f=Array.prototype.slice;Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length>>>0,n=Number(arguments[1])||0;n=n<0?Math.ceil(n):Math.floor(n),n<0&&(n+=t);for(;n<t;n++)if(n in this&&this[n]===e)return n;return-1}),angular.module("ngWebSocket",[]).factory("$websocket",["$rootScope","$q","$timeout","$websocketBackend",l]).factory("WebSocket",["$rootScope","$q","$timeout","WebsocketBackend",l]).service("$websocketBackend",["$window","$log",c]).service("WebSocketBackend",["$window","$log",c]),angular.module("angular-websocket",["ngWebSocket"]),typeof module=="object"&&typeof define!="function"&&(module.exports=angular.module("ngWebSocket"))})();