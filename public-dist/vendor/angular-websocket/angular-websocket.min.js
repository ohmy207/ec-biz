!function(){"use strict";function e(e,t,n,p){function d(t,n,i){i||!a(n)||f(n)||(i=n,n=void 0),this.protocols=n,this.url=t||"Missing URL",this.ssl=/(wss)/i.test(this.url),this.scope=i&&i.scope||e,this.rootScopeFailover=i&&i.rootScopeFailover&&!0,this.useApplyAsync=i&&i.useApplyAsync||!1,this.initialTimeout=i&&i.initialTimeout||500,this.maxTimeout=i&&i.maxTimeout||3e5,this.reconnectIfNotNormalClose=i&&i.reconnectIfNotNormalClose||!1,this._reconnectAttempts=0,this.sendQueue=[],this.onOpenCallbacks=[],this.onMessageCallbacks=[],this.onErrorCallbacks=[],this.onCloseCallbacks=[],r(this._readyStateConstants),t?this._connect():this._setInternalState(0)}return d.prototype._readyStateConstants={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3,RECONNECT_ABORTED:4},d.prototype._normalCloseCode=1e3,d.prototype._reconnectableStatusCodes=[4e3],d.prototype.safeDigest=function(e){e&&!this.scope.$$phase&&this.scope.$digest()},d.prototype.bindToScope=function(t){var n=this;return t&&(this.scope=t,this.rootScopeFailover&&this.scope.$on("$destroy",function(){n.scope=e})),n},d.prototype._connect=function(e){(e||!this.socket||this.socket.readyState!==this._readyStateConstants.OPEN)&&(this.socket=p.create(this.url,this.protocols),this.socket.onmessage=angular.bind(this,this._onMessageHandler),this.socket.onopen=angular.bind(this,this._onOpenHandler),this.socket.onerror=angular.bind(this,this._onErrorHandler),this.socket.onclose=angular.bind(this,this._onCloseHandler))},d.prototype.fireQueue=function(){for(;this.sendQueue.length&&this.socket.readyState===this._readyStateConstants.OPEN;){var e=this.sendQueue.shift();this.socket.send(s(e.message)?e.message:JSON.stringify(e.message)),e.deferred.resolve()}},d.prototype.notifyOpenCallbacks=function(e){for(var t=0;t<this.onOpenCallbacks.length;t++)this.onOpenCallbacks[t].call(this,e)},d.prototype.notifyCloseCallbacks=function(e){for(var t=0;t<this.onCloseCallbacks.length;t++)this.onCloseCallbacks[t].call(this,e)},d.prototype.notifyErrorCallbacks=function(e){for(var t=0;t<this.onErrorCallbacks.length;t++)this.onErrorCallbacks[t].call(this,e)},d.prototype.onOpen=function(e){return this.onOpenCallbacks.push(e),this},d.prototype.onClose=function(e){return this.onCloseCallbacks.push(e),this},d.prototype.onError=function(e){return this.onErrorCallbacks.push(e),this},d.prototype.onMessage=function(e,t){if(!o(e))throw new Error("Callback must be a function");if(t&&u(t.filter)&&!s(t.filter)&&!(t.filter instanceof RegExp))throw new Error("Pattern must be a string or regular expression");return this.onMessageCallbacks.push({fn:e,pattern:t?t.filter:void 0,autoApply:t?t.autoApply:!0}),this},d.prototype._onOpenHandler=function(e){this._reconnectAttempts=0,this.notifyOpenCallbacks(e),this.fireQueue()},d.prototype._onCloseHandler=function(e){this.notifyCloseCallbacks(e),(this.reconnectIfNotNormalClose&&e.code!==this._normalCloseCode||this._reconnectableStatusCodes.indexOf(e.code)>-1)&&this.reconnect()},d.prototype._onErrorHandler=function(e){this.notifyErrorCallbacks(e)},d.prototype._onMessageHandler=function(e){function t(e,t,n){n=c.call(arguments,2),i.useApplyAsync?i.scope.$applyAsync(function(){e.apply(i,n)}):(e.apply(i,n),i.safeDigest(t))}for(var n,r,i=this,o=0;o<i.onMessageCallbacks.length;o++)r=i.onMessageCallbacks[o],n=r.pattern,n?s(n)&&e.data===n?t(r.fn,r.autoApply,e):n instanceof RegExp&&n.exec(e.data)&&t(r.fn,r.autoApply,e):t(r.fn,r.autoApply,e)},d.prototype.close=function(e){return(e||!this.socket.bufferedAmount)&&this.socket.close(),this},d.prototype.send=function(e){function n(e){e.cancel=r;var t=e.then;return e.then=function(){var e=t.apply(this,arguments);return n(e)},e}function r(t){return s.sendQueue.splice(s.sendQueue.indexOf(e),1),i.reject(t),s}var i=t.defer(),s=this,o=n(i.promise);return s.readyState===s._readyStateConstants.RECONNECT_ABORTED?i.reject("Socket connection has been closed"):(s.sendQueue.push({message:e,deferred:i}),s.fireQueue()),p.isMocked&&p.isMocked()&&p.isConnected(this.url)&&this._onMessageHandler(p.mockSend()),o},d.prototype.reconnect=function(){this.close();var e=this._getBackoffDelay(++this._reconnectAttempts),t=e/1e3;return console.log("Reconnecting in "+t+" seconds"),n(angular.bind(this,this._connect),e),this},d.prototype._getBackoffDelay=function(e){var t=Math.random()+1,n=this.initialTimeout,r=2,i=e,s=this.maxTimeout;return Math.floor(Math.min(t*n*Math.pow(r,i),s))},d.prototype._setInternalState=function(e){if(Math.floor(e)!==e||0>e||e>4)throw new Error("state must be an integer between 0 and 4, got: "+e);i||(this.readyState=e||this.socket.readyState),this._internalConnectionState=e,l(this.sendQueue,function(e){e.deferred.reject("Message cancelled due to closed socket connection")})},i&&i(d.prototype,"readyState",{get:function(){return this._internalConnectionState||this.socket.readyState},set:function(){throw new Error("The readyState property is read-only")}}),function(e,t,n){return new d(e,t,n)}}function t(e,t){this.create=function(t,n){var r,i,s=/wss?:\/\//.exec(t);if(!s)throw new Error("Invalid url provided");if("object"==typeof exports&&require)try{i=require("ws"),r=i.Client||i.client||i}catch(o){}return r=r||e.WebSocket||e.MozWebSocket,n?new r(t,n):new r(t)},this.createWebSocketBackend=function(e,n){return t.warn("Deprecated: Please use .create(url, protocols)"),this.create(e,n)}}var n=angular.noop,r=Object.freeze?Object.freeze:n,i=Object.defineProperty,s=angular.isString,o=angular.isFunction,u=angular.isDefined,a=angular.isObject,f=angular.isArray,l=angular.forEach,c=Array.prototype.slice;Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length>>>0,n=Number(arguments[1])||0;for(n=0>n?Math.ceil(n):Math.floor(n),0>n&&(n+=t);t>n;n++)if(n in this&&this[n]===e)return n;return-1}),angular.module("ngWebSocket",[]).factory("$websocket",["$rootScope","$q","$timeout","$websocketBackend",e]).factory("WebSocket",["$rootScope","$q","$timeout","WebsocketBackend",e]).service("$websocketBackend",["$window","$log",t]).service("WebSocketBackend",["$window","$log",t]),angular.module("angular-websocket",["ngWebSocket"]),"object"==typeof module&&"function"!=typeof define&&(module.exports=angular.module("ngWebSocket"))}();